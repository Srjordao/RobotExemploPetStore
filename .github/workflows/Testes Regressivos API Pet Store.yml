name: Testes Regressivos API Pet Store

permissions:
  issues: write

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 * * * *"

jobs:
  create_issue_on_failure:
    name: Criar Issue se Testes Falharem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade setuptools
          pip install allure-robotframework
          pip install robotframework-faker
          pip install robotframework-jsonlibrary
          pip install robotframework-jsonschemalibrary
          pip install robotframework-jsonvalidator
          pip install robotframework-metrics
          pip install robotframework-requests
          pip install robotframework-xvfb
          pip install robotframework-pythonlibcore
          pip install pyyaml
          pip install beautifulsoup4

      - name: Run Robot Framework tests
        run: |
          robot -d output/allure --listener allure_robotframework "tests"
        continue-on-error: true  # Continua o fluxo mesmo se falhar

      - name: Create Issue if Tests Fail
        if: always()  # Sempre executa, independentemente do sucesso ou falha
        uses: actions/github-script@v3
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { JSDOM } = require('jsdom');

            // Configuração dos detalhes da issue
            const issueTitle = `Testes falharam em ${context.workflow} - ${new Date().toISOString()}`;
            
            // Lendo o log HTML
            const logHtmlPath = path.join(process.env.GITHUB_WORKSPACE, 'output/allure/log.html');
            const logContent = fs.existsSync(logHtmlPath) ? fs.readFileSync(logHtmlPath, 'utf8') : 'Log de erro não encontrado.';

            // Extraindo falhas usando JSDOM para processar HTML
            const dom = new JSDOM(logContent);
            const document = dom.window.document;

            // Seleciona as seções que contêm falhas
            const failSections = Array.from(document.querySelectorAll('div.fail')).map(el => el.textContent).join('\n');

            const issueBody = `
              ## Detalhes do Erro

              **Logs de Erro dos Testes Falhados:**
              \`\`\`
              ${failSections.slice(0, 10000)}  // Limitando a 10000 caracteres para não sobrecarregar a issue
              \`\`\`

              **Action:** Verifique os logs para identificar e corrigir os erros.
            `;

            // Criar a issue no repositório
            await github.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'automated test failure'],  // Adiciona etiquetas à issue
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Allure Report as Artifact
        uses: actions/upload-artifact@v2
        with:
          name: allure-report
          path: output/allure

  hourly_job:
    name: Hourly Job
    runs-on: ubuntu-latest
    steps:
      - name: Print Current Time
        run: echo "The current time is $(date)"
