name: Testes Regressivos API Pet Store

permissions:
  issues: write

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 * * * *"

jobs:
  create_issue_on_failure:
    name: Criar Issue se Testes Falharem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade setuptools
          pip install allure-robotframework
          pip install robotframework-faker
          pip install robotframework-jsonlibrary
          pip install robotframework-jsonschemalibrary
          pip install robotframework-jsonvalidator
          pip install robotframework-metrics
          pip install robotframework-requests
          pip install robotframework-xvfb
          pip install robotframework-pythonlibcore
          pip install pyyaml
          pip install beautifulsoup4

      - name: Run Robot Framework tests
        run: |
          robot -d output/allure --listener allure_robotframework "tests"
        continue-on-error: true  # Continua o fluxo mesmo se falhar

      - name: Extract Error Logs
        if: failure()
        run: |
          # Usar BeautifulSoup para extrair logs de erro
          python -c "
import os
from bs4 import BeautifulSoup

log_html_path = 'output/allure/log.html'
error_log_path = 'output/allure/error_log.txt'

if os.path.exists(log_html_path):
    with open(log_html_path, 'r') as file:
        soup = BeautifulSoup(file, 'html.parser')
        error_logs = soup.find_all(class_='error')  # Ajustar a classe conforme necessário

        with open(error_log_path, 'w') as error_file:
            for log in error_logs:
                error_file.write(log.get_text(separator='\n'))
else:
    with open(error_log_path, 'w') as error_file:
        error_file.write('Log HTML não encontrado.')
          "

      - name: Create Issue if Tests Fail
        if: failure()
        uses: actions/github-script@v3
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Configuração dos detalhes da issue
            const issueTitle = `Testes falharam em ${context.workflow} - ${new Date().toISOString()}`;
            
            // Lendo o log de erro
            const errorLogPath = path.join(process.env.GITHUB_WORKSPACE, 'output/allure/error_log.txt');
            const errorLog = fs.existsSync(errorLogPath) ? fs.readFileSync(errorLogPath, 'utf8') : 'Log de erro não encontrado.';

            const issueBody = `
              ## Detalhes do Erro

              **Log de Erro:**
              \`\`\`
              ${errorLog.slice(0, 1000)}  // Limitando a 1000 caracteres para não sobrecarregar a issue
              \`\`\`

              **Action:** Verifique os logs para identificar e corrigir os erros.
            `;

            // Criar a issue no repositório
            await github.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'automated test failure'],  // Adiciona etiquetas à issue
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Allure Report as Artifact
        uses: actions/upload-artifact@v2
        with:
          name: allure-report
          path: output/allure

  hourly_job:
    name: Hourly Job
    runs-on: ubuntu-latest
    steps:
      - name: Print Current Time
        run: echo "The current time is $(date)"
