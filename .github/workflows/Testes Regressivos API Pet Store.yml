name: Testes Regressivos API Pet Store

permissions:
  issues: write

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 * * * *"

jobs:
  run_tests_and_create_issue:
    name: Executar Testes e Criar Issue se Falhar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade setuptools
          pip install allure-robotframework
          pip install robotframework-faker
          pip install robotframework-jsonlibrary
          pip install robotframework-jsonschemalibrary
          pip install robotframework-jsonvalidator
          pip install robotframework-metrics
          pip install robotframework-requests
          pip install robotframework-xvfb
          pip install robotframework-pythonlibcore
          pip install pyyaml
          pip install beautifulsoup4

      - name: Run Robot Framework tests
        run: |
          robot -d output/allure --listener allure_robotframework "tests"
        continue-on-error: true  # Continua o fluxo mesmo se falhar

      - name: Extract Failed Tests from XML
        id: extract_failures
        run: |
          FAILED_TESTS=$(xmllint --xpath "//test[@status='FAIL']/@name" output/output.xml)
          echo "failed_tests=${FAILED_TESTS}" >> $GITHUB_ENV

      - name: Create Issue for Failed Tests
        if: ${{ env.failed_tests != "" }}
        run: |
          TITLE="Test Failures Detected"
          BODY="The following tests failed:\n${{ env.failed_tests }}\n\nCheck the full report for more details."
          gh api -X POST repos/${{ github.repository }}/issues \
            -f title="$TITLE" \
            -f body="$BODY" \
            -f labels="bug"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Allure Report as Artifact
        uses: actions/upload-artifact@v2
        with:
          name: allure-report
          path: output/allure