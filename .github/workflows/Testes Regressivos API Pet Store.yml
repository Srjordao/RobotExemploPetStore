name: Testes Regressivos API Pet Store

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 * * * *"

jobs:
  run_robot_tests:
    name: Testes Regressivos API Pet Store
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade setuptools
          pip install allure-robotframework
          pip install robotframework-faker
          pip install robotframework-jsonlibrary
          pip install robotframework-jsonschemalibrary
          pip install robotframework-jsonvalidator
          pip install robotframework-metrics
          pip install robotframework-requests
          pip install robotframework-xvfb
          pip install robotframework-pythonlibcore
          pip install pyyaml

      - name: Run Robot Framework tests
        run: |
          robot -d output/allure --listener allure_robotframework "tests"
        continue-on-error: false

      - name: Processar Logs de Erro
        if: failure()
        run: |
          mkdir -p output/error_logs
          rebot --report NONE --log NONE --output NONE --outputdir output/error_logs --loglevel DEBUG:FAIL output/allure/output.xml

      - name: Criar Issue se Testes falharem
        if: failure()
        uses: actions/github-script@v3
        with:
          script: |
            const { Octokit } = require("@octokit/rest");
            const fs = require('fs');
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

            // Configuração dos detalhes da issue
            const issueTitle = `Testes falharam em ${context.workflow} - ${new Date().toISOString()}`;
            const failedTests = require('./output/allure/output.json').statistics.total.failed;
            const errorLog = fs.readFileSync('output/error_logs/log.html', 'utf8');
            const issueBody = `
              ## Detalhes do Erro

              **Número de testes falhados:** ${failedTests}

              **Logs de Erro:** [Clique aqui para acessar o log completo](./output/error_logs/log.html)

              \`\`\`
              ${errorLog.slice(0, 1000)}  // Limitando a 1000 caracteres para não sobrecarregar a issue
              \`\`\`

              **Action:** Verifique os logs para identificar e corrigir os erros.
            `;

            // Criar a issue no repositório
            await octokit.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'automated test failure'],  // Adiciona etiquetas à issue
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Allure Report as Artifact
        uses: actions/upload-artifact@v2
        with:
          name: allure-report
          path: output/allure

  hourly_job:
    name: Hourly Job
    runs-on: ubuntu-latest
    steps:
      - name: Print Current Time
        run: echo "The current time is $(date)"
